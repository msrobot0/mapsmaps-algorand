"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.executeDeployTask = void 0;
const web_1 = require("@algo-builder/web");
const fs_1 = __importDefault(require("fs"));
const config_env_1 = require("../internal/core/config/config-env");
const files_1 = require("../internal/util/files");
const algo_operator_1 = require("../lib/algo-operator");
const files_2 = require("../lib/files");
const script_checkpoints_1 = require("../lib/script-checkpoints");
const run_1 = require("./run");
const task_names_1 = require("./task-names");
function clearCheckpointFiles(scriptNames) {
    scriptNames.forEach(scriptName => {
        try {
            // fs.unlink deletes the file
            fs_1.default.unlinkSync((0, script_checkpoints_1.toCheckpointFileName)(scriptName));
        }
        catch (e) {
            // ignored
        }
    });
}
async function executeDeployTask({ fileNames, force }, runtimeEnv, algoOp) {
    const logDebugTag = "algob:tasks:deploy";
    const scriptNames = fileNames.length === 0
        ? (0, files_1.loadFilenames)(script_checkpoints_1.scriptsDirectory)
        : (0, files_2.assertDirectDirChildren)(script_checkpoints_1.scriptsDirectory, fileNames);
    if (scriptNames.length === 0) {
        throw new web_1.BuilderError(web_1.ERRORS.BUILTIN_TASKS.SCRIPTS_NO_FILES_FOUND, {
            directory: script_checkpoints_1.scriptsDirectory
        });
    }
    if (force) {
        clearCheckpointFiles(scriptNames);
    }
    const onSuccessFn = (cpData, relativeScriptPath) => {
        (0, script_checkpoints_1.persistCheckpoint)(relativeScriptPath, cpData.strippedCP);
    };
    return await (0, run_1.runMultipleScripts)(runtimeEnv, scriptNames, onSuccessFn, force, logDebugTag, true, algoOp);
}
exports.executeDeployTask = executeDeployTask;
function default_1() {
    (0, config_env_1.task)(task_names_1.TASK_DEPLOY, "Compiles and runs user-defined scripts from scripts directory")
        .addFlag("force", "Run the scripts even if checkpoint state already exist (Danger: it will overwrite them).")
        .addOptionalVariadicPositionalParam("fileNames", "A directory that contains js files to be run within algob's environment", [])
        .setAction((input, env) => executeDeployTask(input, env, (0, algo_operator_1.createAlgoOperator)(env.network)));
}
exports.default = default_1;
//# sourceMappingURL=deploy.js.map